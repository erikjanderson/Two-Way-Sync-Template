<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_156954_two_way.TWTempObjectMap</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>TWTempObjectMap</name>
        <script><![CDATA[var TWTempObjectMap = Class.create();
TWTempObjectMap.prototype = {
	initialize: function (twTempObjectMapGr) {
		if (twTempObjectMapGr) {
			if (typeof twTempObjectMapGr === "string") {
				twTempObjectMapGr = this._getGlideRecordWithId(twTempObjectMapGr);
			}
			if (twTempObjectMapGr + "" === "[object GlideRecord]") {
				this.setFromGr(twTempObjectMapGr);
			} else if (twTempObjectMapGr + "" === "[object Object]") {
				this.setFromModel(twTempObjectMapGr);
			}
		}
	},

	previewAndConvert: function(gr){
		var previewObj = this.previewGr(gr);
		gs.debug('Two Way Sync Template TWTempObjectMap (previewAndConvert) previewObj: ' + JSON.stringify(previewObj));
		if(previewObj){
			var twTempObject = this.convertToTWTempObject(previewObj);
		}
		return twTempObject;
	},

	previewGr: function (gr) {
		var validGr = this._validateGrTable(gr);
		if (!validGr) {
			gs.warn('Two Way Sync Template TWTempObjectMap (previewGr): ' + gr.getTableName() + ' is not in the same hierarchy as this map. Map table is ' + this.snTable);
			return;
		}
		var previewObj = this._getGrProperties(gr);
		for (var i = 0; i < this.childMaps.length; i++) {
			var childMap = this.childMaps[i];
			if (childMap.childType === 'array') {
				previewObj[childMap.sysId] = {
					path: childMap.snTable,
					val: []
				}
				var childGr = this._getChildGr(childMap, gr);
				while (childGr.next()) {
					var childPreviewObj = childMap.previewGr(childGr);
					if (childPreviewObj) {
						previewObj[childMap.sysId].val.push(childPreviewObj);
					}
				}
			} else if (childMap.childType === 'object') {
				previewObj[childMap.sysId] = {
					path: childMap.snTable,
					val: {}
				}
				var childGr = this._getChildGr(childMap, gr);
				if (childGr.next()) {
					var childPreviewObj = childMap.previewGr(childGr);
					if (childPreviewObj) {
						previewObj[childMap.sysId].val = childPreviewObj;
					}
				}
			}
		}
		return previewObj;
	},

	convertToTWTempObject: function (previewObject) {
		if (!previewObject) {
			gs.warn('Two Way Sync Template TWTempObjectMap (convertToTWTempObject): no previewObject provided.');
			return;
		}
		if (!this.twTempObject.type) {
			this.twTempObject = new TWTempObject(this.twTempObject.id);
		}
		this.twTempObject.initializeNewObject();
		this._pathDictionary = this._buildPathDictionary();
		gs.debug('Two Way Sync Template TWTempObjectMap (convertToTWTempObject) this._pathDictionary: ' + JSON.stringify(this._pathDictionary));
		var indexedPreviewObject = this._indexPreviewObject(previewObject);
		gs.debug('Two Way Sync Template TWTempObjectMap (convertToTWTempObject) indexedPreviewObject: ' + JSON.stringify(indexedPreviewObject));


		for (var propertyPath in indexedPreviewObject.propertyDictionary) {
			var genericPath = propertyPath.replace(/(\[)(.*?)(])/g, '[*]');
			var value = indexedPreviewObject.propertyDictionary[propertyPath];
			if (this._pathDictionary.propertyDictionary[genericPath] && this._pathDictionary.propertyDictionary[genericPath].targetId) {
				var locations = this._getPathLocations(propertyPath);
				this.twTempObject.setValue(this._pathDictionary.propertyDictionary[genericPath].targetId, value, locations)
			}

		}
		return this.twTempObject.getTWObject();
	},

	importTWTempObject: function(twTempObject, parentGr){

		if(!this.twTempObject.type){
			this.twTempObject = new TWTempObject(this.twTempObject.id);
		}

		//var indexedObject = this.twTempObject.indexObject(twTempObject);
		//gs.info(JSON.stringify(indexedObject))

		var snKeyValues = this._convertTWTempObjectToSN(twTempObject, parentGr);

		gs.info(JSON.stringify(snKeyValues));

		var gr = this._lookupGr(snKeyValues, parentGr);
		if(gr){
			for(var key in snKeyValues){
				gr.setValue(key, snKeyValues[key]);
			}
			if(gr.getUniqueValue()){
				gr.update();
			}else{
				gr.insert();
			}
		}

		// this._importChildTWTempObjects(twTempObject, gr);
	},

	setFromGr: function (twTempObjectMapGr) {
		if(twTempObjectMapGr.getValue('u_active') == '0'){
			gs.warn('Two Way Sync Template TWTempObjectMap (setFromGR): The' + twTempObjectMapGr.getValue("u_name") + ' is inactive and cannot be used. Please activate it if you wish to initialize it.');
		}
		this.sysId = twTempObjectMapGr.getUniqueValue();
		this.name = twTempObjectMapGr.getValue("u_name");
		this.snTable = twTempObjectMapGr.getValue("u_sn_table");
		this.parentSysId = twTempObjectMapGr.getValue('u_parent');
		this.referenceField = twTempObjectMapGr.getValue("u_reference_field");
		this.childType = twTempObjectMapGr.getValue("u_child_type");
		//this.twTempObject = this._getReferenceField("u_twtemp_object", twTempObjectMapGr, 'u_name');
		this.twTempObject = new TWTempObject(twTempObjectMapGr.getValue('u_twtemp_object'));
		var propertyData = this._getPropertyMaps();

		this.propertyMaps = propertyData.propertyMaps;
		this.coalesceProperties = propertyData.coalesceProperties;
		this.childMaps = this._getChildMaps();
	},

	setFromModel: function (model) {
		for (var key in model) {
			this[key] = model[key];
		}
	},

	//Internal Functions

	_getChildMaps: function () {
		var childMaps = [];
		var twTempObjectMapGr = new GlideRecord("x_156954_two_way_object_map");
		twTempObjectMapGr.addQuery('u_parent', this.sysId);
		twTempObjectMapGr.addQuery('u_active', true);
		twTempObjectMapGr.query();
		while (twTempObjectMapGr.next()) {
			childMaps.push(new TWTempObjectMap(twTempObjectMapGr));
		}
		return childMaps;
	},

	_getPropertyMaps: function () {
		var propertyMaps = [];
		var coalesceProperties = [];
		var twTempObjectPropertyMapGr = new GlideRecord("x_156954_two_way_object_property_map");
		twTempObjectPropertyMapGr.addQuery('u_map', this.sysId);
		twTempObjectPropertyMapGr.addQuery('u_active', true);
		twTempObjectPropertyMapGr.query();
		while (twTempObjectPropertyMapGr.next()) {
			var propertyMap = new TWTempObjectPropertyMap(twTempObjectPropertyMapGr)
			propertyMaps.push(propertyMap);
			if(propertyMap.coalesce){
				coalesceProperties.push(propertyMap);
			}
		}
		return {
			propertyMaps: propertyMaps,
			coalesceProperties: coalesceProperties
		};
	},

	_getReferenceField: function (columnName, twTempObjectMapGr, overrideDisplay) {
		var returnObj = {};
		if (columnName) {
			returnObj.id = twTempObjectMapGr.getValue(columnName);
			if(!overrideDisplay){
				returnObj.displayValue = twTempObjectMapGr.getDisplayValue(columnName);
			}else{
				returnObj.displayValue = twTempObjectMapGr.getElement(columnName + '.' + overrideDisplay).toString();
			}
			
		}
		return returnObj;
	},


	_getGlideRecordWithId: function (id) {
		var twTempObjectMapGr = new GlideRecord("x_156954_two_way_object_map");
		if (twTempObjectMapGr.get(id)) {
			return twTempObjectMapGr;
		}
	},

	_validateGrTable: function (gr) {
		var grTable = gr.getTableName();
		var snTableHierarchy = new GlideTableHierarchy(this.snTable);
		var tableExtensions = snTableHierarchy.getAllExtensions();
		if (tableExtensions.indexOf(grTable) > -1) {
			return true;
		} else {
			return false;
		}
	},

	_getGrProperties: function (gr) {
		var properties = {};
		for (var i = 0; i < this.propertyMaps.length; i++) {
			var propertyMap = this.propertyMaps[i];
			var field = propertyMap.snField;
			//Apply some additional scripting logic?
			properties[propertyMap.sysId] = {
				val: gr.getElement(field).toString(),
				path: field
			};
		}
		return properties;
	},

	_getChildGr: function (childMap, gr) {
		var childGr = new GlideRecord(childMap.snTable);
		childGr.addQuery(childMap.referenceField, gr.getUniqueValue());
		childGr.query();
		return childGr;
	},

	_settwTempProperties: function (previewObject) {
		for (var i = 0; i < this.propertyMaps.length; i++) {
			var propertyMap = this.propertyMaps[i];
			this.twTempObject.setValue(propertyMap.twTempProperty.displayValue, previewObject[propertyMap.snField]);
		}
	},

	_buildPathDictionary: function (pathDictionary, prePath) {
		if(this._pathDictionary){
			return this._pathDictionary;
		}
		if (!pathDictionary) {
			pathDictionary = {
				propertyDictionary: {},
				objectDictionary: {}
			};
			prePath = '';
		} else {
			prePath += '.';
		}
		for (var i = 0; i < this.propertyMaps.length; i++) {
			var propertyMap = this.propertyMaps[i];
			pathDictionary.propertyDictionary[prePath + propertyMap.sysId] = {
				targetId: propertyMap.twTempProperty.id,
				propertyId:  propertyMap.sysId
			}
		}
		for (var c = 0; c < this.childMaps.length; c++) {
			var childMap = this.childMaps[c];
			var childPath = prePath + childMap.sysId;
			if (childMap.childType === 'array') {
				childPath += '[*]';
			}
			pathDictionary.objectDictionary[childPath] = {
				targetId: childMap.twTempObject.id,
				path: childPath
			};
			pathDictionary = childMap._buildPathDictionary(pathDictionary, childPath);
		}
		return pathDictionary;
	},

	_indexPreviewObject: function (previewObj, previewPathDictionary, currentPath) {
		if (!previewPathDictionary) {
			previewPathDictionary = {
				propertyDictionary: {},
				objectDictionary: {}
			};
			currentPath = '';
		} else {
			currentPath += '.';
		}
		for (var key in previewObj) {
			var newPath = currentPath + key;
			if (typeof previewObj[key].val === 'object') {
				if (Array.isArray(previewObj[key].val)) {
					previewPathDictionary = this._buildPreviewArrayTargetMap(previewObj[key].val, previewPathDictionary, newPath);
				} else {
					previewPathDictionary.objectDictionary[newPath] = {};
					previewPathDictionary = this._indexPreviewObject(previewObj[key].val, previewPathDictionary, newPath);
				}
			} else {
				previewPathDictionary.propertyDictionary[newPath] = previewObj[key].val;
			}
		}
		return previewPathDictionary;
	},

	_buildPreviewArrayTargetMap: function (previewObj, previewPathDictionary, currentPath) {
		for (var i = 0; i < previewObj.length; i++) {
			var newPath = currentPath + '[' + i + ']';
			previewPathDictionary.objectDictionary[newPath] = [];
			previewPathDictionary = this._indexPreviewObject(previewObj[i], previewPathDictionary, newPath);
		}
		return previewPathDictionary;
	},

	_getPathLocations: function (fullPath) {
		var locations = fullPath.match(/(?=\[)(.*?)(?=])/g);
		if(!locations){
			return [];
		}
		for (var i = 0; i < locations.length; i++) {
			locations[i] = parseInt(locations[i].replace('[', ''));;
		}
		return locations;
	},

	_convertTWTempObjectToSN: function(twTempObject, parentGr){
		var snKeyValues = {};
		for(var i = 0; i < this.propertyMaps.length; i++){
			var propertyMap = this.propertyMaps[i];
			if(propertyMap.twTempProperty && propertyMap.twTempProperty.displayValue && twTempObject[propertyMap.twTempProperty.displayValue]){
				snKeyValues[propertyMap.snField] = twTempObject[propertyMap.twTempProperty.displayValue];
			}else{
				snKeyValues[propertyMap.snField] = "";
			}
		}

		if(parentGr && this.parentSysId && this.referenceField){
			snKeyValues[this.referenceField] = parentGr.getUniqueValue();
		}

		return snKeyValues;

	},

	_lookupGr: function(snKeyValues, relatedGr){
		var gr = new GlideRecord(this.snTable);
		if(this.parentSysId && this.referenceField && relatedGr){
			gr.addQuery(this.referenceField, relatedGr.getUniqueValue());
		}
		for(var i = 0; i < this.coalesceProperties.length; i++){
			var property = this.coalesceProperties[i];
			gr.addQuery(property.snField, snKeyValues[property.snField]);
		}
		gr.setLimit(1);
		gr.query();
		if(gr.hasNext()){
			gr.next();
		}else{
			gr.initialize();
		}
		return gr;
	},

	_importChildTWTempObjects: function(twTempObject, parentGr){
		for(var i = 0; i < this.childMaps.length; i++){
			var childMap = this.childMaps[i];
			if(twTempObject[childMap.twTempObject.name]){
				if(childMap.twTempObject.objectType === 'array'){
					for(var c = 0; c < twTempObject[childMap.twTempObject.name].length; c++){
						var arrayItem = twTempObject[childMap.twTempObject.name][c];
						childMap.importTWTempObject(arrayItem, parentGr);
					}
				}else if(childMap.twTempObject.objectType === 'object'){
					childMap.importTWTempObject(twTempObject[childMap.twTempObject.name], parentGr);
				}
			}
		}
	},


	type: 'TWTempObjectMap'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>erik.anderson</sys_created_by>
        <sys_created_on>2023-06-27 11:54:23</sys_created_on>
        <sys_id>3c3535ff47272150acb08f22736d43ba</sys_id>
        <sys_mod_count>230</sys_mod_count>
        <sys_name>TWTempObjectMap</sys_name>
        <sys_package display_value="Two Way Sync Template" source="x_156954_two_way">a5942439475ba110acb08f22736d43bc</sys_package>
        <sys_policy/>
        <sys_scope display_value="Two Way Sync Template">a5942439475ba110acb08f22736d43bc</sys_scope>
        <sys_update_name>sys_script_include_3c3535ff47272150acb08f22736d43ba</sys_update_name>
        <sys_updated_by>erik.anderson</sys_updated_by>
        <sys_updated_on>2023-07-12 13:24:20</sys_updated_on>
    </sys_script_include>
</record_update>
